// Related Articles Carousel - Auto-updates when new reviews are added
// Reads JSON data generated by Jekyll and creates a shuffled carousel

console.log('Related articles carousel script loaded');

(function() {
    'use strict';

    console.log('Related articles carousel: Initializing...');

    // Shuffle array function (Fisher-Yates algorithm)
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Initialize carousel when DOM is ready
    function initCarousel() {
        const reviewsDataElement = document.getElementById('all-reviews-data');
        const wrapper = document.getElementById('related-articles-wrapper');
        
        if (!reviewsDataElement || !wrapper) {
            console.warn('Related articles carousel: Data or wrapper not found');
            return;
        }

        try {
            const jsonText = reviewsDataElement.textContent.trim();
            console.log('Found reviews data, length:', jsonText.length);
            console.log('First 300 chars:', jsonText.substring(0, 300));
            
            if (!jsonText || jsonText === '[]' || jsonText.length < 10) {
                console.warn('No reviews data found or empty array');
                return;
            }
            
            const allReviews = JSON.parse(jsonText);
            console.log('Parsed reviews:', allReviews.length, 'articles found');
            
            if (allReviews.length === 0) {
                console.warn('No reviews in the array');
                return;
            }
            const currentUrl = window.location.pathname;
            
            // Filter out current page and shuffle
            const relatedReviews = shuffleArray(
                allReviews.filter(review => {
                    // Normalize URLs for comparison
                    const reviewUrl = review.url.replace(/\/$/, '');
                    const currentUrlNormalized = currentUrl.replace(/\/$/, '');
                    return reviewUrl !== currentUrlNormalized && reviewUrl !== '';
                })
            ).slice(0, 12); // Show up to 12 articles in carousel
            
            if (relatedReviews.length === 0) {
                console.warn('Related articles carousel: No reviews found');
                return;
            }

            // Clear existing fallback content
            wrapper.innerHTML = '';
            
            // Generate HTML for each review
            relatedReviews.forEach((review, index) => {
                const slide = document.createElement('div');
                slide.className = 'swiper-slide';
                slide.setAttribute('role', 'listitem');
                slide.setAttribute('aria-label', `Article ${index + 1} of ${relatedReviews.length}: ${review.title || 'Related Article'}`);
                const reviewTitle = review.title || 'Related Article';
                slide.innerHTML = `
                    <div class="related-article-card">
                        <a href="${review.url}" aria-label="Read article: ${reviewTitle}">
                            <img src="${review.image || ''}" 
                                 alt="${reviewTitle}" 
                                 class="related-article-image"
                                 loading="lazy"
                                 width="300"
                                 height="200"
                                 decoding="async"
                                 onerror="this.src='${review.image || ''}'; this.onerror=null;">
                        </a>
                        <div class="related-article-content">
                            <a href="${review.url}" aria-label="Read article: ${reviewTitle}">
                                <h3>${reviewTitle}</h3>
                            </a>
                            <p>${review.description || ''}</p>
                        </div>
                    </div>
                `;
                wrapper.appendChild(slide);
            });
            
            // Initialize Swiper only if it's loaded
            if (typeof Swiper !== 'undefined') {
                const swiperContainer = document.querySelector('.related-articles-swiper');
                if (!swiperContainer) {
                    console.warn('Swiper container not found');
                    return;
                }
                
                new Swiper(swiperContainer, {
                    slidesPerView: 1,
                    spaceBetween: 20,
                    navigation: {
                        nextEl: swiperContainer.querySelector('.swiper-button-next'),
                        prevEl: swiperContainer.querySelector('.swiper-button-prev'),
                    },
                    pagination: {
                        el: swiperContainer.querySelector('.swiper-pagination'),
                        clickable: true,
                        dynamicBullets: true,
                    },
                    // Touch/swipe support (essential for mobile)
                    touchEventsTarget: 'container',
                    touchRatio: 1,
                    touchAngle: 45,
                    grabCursor: true,
                    // Responsive breakpoints
                    breakpoints: {
                        640: {
                            slidesPerView: 2,
                            spaceBetween: 20,
                        },
                        768: {
                            slidesPerView: 3,
                            spaceBetween: 30,
                        },
                        1024: {
                            slidesPerView: 4,
                            spaceBetween: 30,
                        },
                    },
                    // Accessibility
                    a11y: {
                        prevSlideMessage: 'Previous related articles',
                        nextSlideMessage: 'Next related articles',
                        firstSlideMessage: 'This is the first related article',
                        lastSlideMessage: 'This is the last related article',
                    },
                    // Keyboard navigation
                    keyboard: {
                        enabled: true,
                        onlyInViewport: true,
                    },
                    // Mouse wheel support (desktop)
                    mousewheel: {
                        forceToAxis: true,
                        sensitivity: 1,
                    },
                });
            } else {
                console.warn('Swiper library not loaded. Carousel will not function.');
            }
        } catch (error) {
            console.error('Error initializing related articles carousel:', error);
        }
    }

    // Wait for DOM and Swiper library to be ready
    function initWhenReady() {
        console.log('Checking for Swiper...', typeof Swiper);
        
        if (typeof Swiper === 'undefined') {
            console.log('Swiper not yet loaded, waiting...');
            setTimeout(initWhenReady, 100);
            return;
        }
        
        console.log('Swiper is available! Initializing carousel...');
        
        // Wait for DOM to be fully ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCarousel);
        } else {
            // Use a small delay to ensure everything is ready
            setTimeout(initCarousel, 50);
        }
    }

    // Start initialization
    initWhenReady();
})();

